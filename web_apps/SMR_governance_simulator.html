<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Wylfa SMR – Governance Simulator (Compact Edition)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b0d10; --panel:#11151a; --card:#0e1318; --fg:#e6edf3; --muted:#8a95a3;
    --accent:#7cc4ff; --accent-2:#9ee493; --border:#1f2a36; --good:#55d69e; --warn:#ffcc66; --bad:#ff6b6b;
    --radius:10px; --space:10px; --space-sm:6px; --font:13px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:var(--font)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  header{position:sticky;top:0;z-index:20;background:#0b0d10;border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:10px}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .topbar h1{margin:0;font-size:15px;font-weight:700}
  .toolbar{display:flex;gap:6px;flex-wrap:wrap}
  .btn,.iconbtn{
    background:#0f141a;border:1px solid var(--border);color:var(--fg);padding:6px 10px;border-radius:8px;cursor:pointer;
  }
  .iconbtn{padding:6px 8px;font-weight:700}
  .btn.primary{background:var(--accent);color:#06263d;border-color:#0f3752}
  .badge{border:1px solid var(--border);padding:2px 6px;border-radius:999px;color:var(--muted);font-size:11px}
  .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:10px;margin-top:10px}
  @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:10px}
  .panel h2{margin:.1rem 0 .4rem;font-size:14px}
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  @media(max-width:900px){.metrics{grid-template-columns:repeat(2,1fr)}}
  .metric{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:8px;display:grid;grid-template-columns:1fr auto;align-items:start;gap:6px}
  .metric .k{color:var(--muted);font-size:12px}
  .metric .v{font-weight:700}
  .ico{border:1px solid var(--border);background:#0a1117;color:var(--muted);width:22px;height:22px;border-radius:50%;display:inline-grid;place-items:center;cursor:pointer}
  .timeline{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center}
  .bar{height:12px;border-radius:999px;background:#121820;border:1px solid var(--border);overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
  .legend{display:flex;gap:8px;color:var(--muted);font-size:11px;flex-wrap:wrap}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:900px){.actions{grid-template-columns:1fr}}
  .action{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:8px;display:grid;grid-template-columns:1fr auto;gap:6px}
  .action .name{font-weight:700}
  .action .desc{color:var(--muted);font-size:12px}
  .action .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);color:var(--muted);background:#0b1117}
  .action button{background:var(--accent);color:#06263d;border:none;border-radius:8px;padding:6px 8px;font-weight:800;cursor:pointer;height:30px}
  .action button[disabled]{opacity:.45;cursor:not-allowed}
  .log{background:#0c1218;border:1px solid var(--border);border-radius:var(--radius);padding:8px;height:160px;overflow:auto;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
  .pill{padding:1px 5px;border-radius:6px;font-size:11px;border:1px solid transparent}
  .ok{background:rgba(85,214,158,.15);color:var(--good);border-color:rgba(85,214,158,.25)}
  .warn{background:rgba(255,204,102,.12);color:var(--warn);border-color:rgba(255,204,102,.25)}
  .bad{background:rgba(255,107,107,.12);color:var(--bad);border-color:rgba(255,107,107,.25)}
  .muted{color:var(--muted)}
  details{background:#0d1319;border:1px solid var(--border);border-radius:var(--radius);padding:8px}
  summary{cursor:pointer;font-weight:700}
  .kbd{font-family:ui-monospace,Consolas,Menlo,monospace}
  .right{text-align:right}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Modal & popover */
  dialog{border:none;padding:0;background:transparent}
  .modal{background:#0d1319;border:1px solid var(--border);border-radius:12px;max-width:720px;width:min(720px,92vw);box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal .hd{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:10px 12px}
  .modal .bd{padding:10px 12px}
  .modal .ft{padding:10px 12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:8px}
  .ghost{background:#0f141a;border:1px solid var(--border);color:var(--fg);padding:6px 10px;border-radius:8px;cursor:pointer}
  .pop{position:fixed;inset:auto 10px 10px auto;max-width:360px;background:#0e141a;border:1px solid var(--border);border-radius:10px;padding:10px;display:none;z-index:50}
  .pop h4{margin:.2rem 0 .4rem}
  .pop .close{float:right;border:none;background:transparent;color:var(--muted);cursor:pointer}

  /* Compact mode */
  body.compact .log{height:140px}
  body.compact .metrics{grid-template-columns:repeat(3,1fr)}
  body.compact .panel{padding:8px}
</style>
</head>
<body class="compact">
<header>
  <div class="wrap topbar">
    <div class="row">
      <h1>Wylfa SMR – Governance Simulator</h1>
      <span class="badge">Start: Q1‑2026</span>
      <span class="badge">Target FID: Q4‑2028</span>
      <span class="badge">First power: 2030s</span>
    </div>
    <div class="toolbar">
      <a class="btn" href="../index.html">Back to Card Index</a>
      <button class="iconbtn" id="quickGuideBtn" title="Quick Guide (?)">?</button>
      <button class="btn primary" id="oneClickBtn" title="Choose a recommended action and advance (A)">▶ One‑click Turn</button>
      <button class="btn" id="endTurn">Next Quarter (Space)</button>
      <button class="btn" id="auto4">Auto‑run 4q</button>
      <button class="btn" id="autoYear">Auto‑run 1y</button>
      <button class="btn" id="saveBtn">Save</button>
      <button class="btn" id="loadBtn">Load</button>
      <button class="btn" id="resetBtn" title="Reset (R)">Reset</button>
      <button class="btn" id="compactBtn" title="Toggle compact mode">Compact</button>
      <span class="badge">RNG seed: <span id="seedBadge"></span></span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <section class="panel">
      <h2>Programme</h2>
      <div class="metrics" id="metrics"></div>

      <div class="timeline" style="margin-top:8px">
        <div>
          <div class="muted">Quarter</div>
          <div id="clock" class="badge">—</div>
        </div>
        <div>
          <div class="bar"><div id="progress" class="fill"></div></div>
          <div class="legend">
            <span>Start <span id="startQ" class="kbd"></span></span>
            <span>FID <span id="targetFID" class="kbd"></span></span>
            <span>First Power <span id="targetFP" class="kbd"></span></span>
          </div>
        </div>
      </div>

      <div style="height:6px"></div>
      <div class="row">
        <strong>Available actions</strong>
        <span class="muted">Tip: hit <span class="kbd">A</span> for a recommended move, then <span class="kbd">Space</span>.</span>
      </div>
      <div id="actions" class="actions"></div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <h2>Event log</h2>
      <div id="log" class="log" aria-live="polite"></div>

      <div style="height:8px"></div>
      <details>
        <summary>Data & sources (key facts)</summary>
        <div class="muted">
          <ul style="margin-top:.4rem">
            <li><strong>Wylfa selected</strong> for UK’s first SMR site; initially <strong>three</strong> Rolls‑Royce SMRs; assessed potential up to <strong>eight</strong>. Press release & statements (Nov 2025).</li>
            <li><strong>GDA</strong> (ONR/EA/NRW) runs in <strong>three steps</strong>; endpoint is ONR’s <strong>DAC</strong> & EA’s <strong>SoDA</strong>. RR SMR entered <strong>Step 3</strong> in 2024.</li>
            <li><strong>Financing</strong>: GBE‑N public equity; optional <strong>RAB</strong> under the 2022 Act with Ofgem revenue collection rules.</li>
            <li><strong>Timing</strong>: first power targeted in the <strong>2030s</strong>; delays driven by supply chain, licensing and engagement.</li>
          </ul>
        </div>
      </details>

      <div style="height:8px"></div>
      <details>
        <summary>Ruleset (JSON)</summary>
        <pre id="rulesText" class="muted" style="white-space:pre-wrap;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px"></pre>
      </details>

      <div style="height:8px"></div>
      <div class="row muted">
        <div><strong>Shortcuts:</strong> <span class="kbd">?</span> guide, <span class="kbd">A</span> one‑click, <span class="kbd">Space</span> next quarter, <span class="kbd">R</span> reset, <span class="kbd">S</span> save, <span class="kbd">L</span> load.</div>
      </div>
    </section>
  </div>
</main>

<!-- Explainer popover -->
<div id="popover" class="pop" role="dialog" aria-modal="false">
  <button class="close" id="popClose" aria-label="Close">✕</button>
  <h4 id="popTitle">Explainer</h4>
  <div id="popBody" class="muted" style="font-size:12px"></div>
</div>

<!-- Quick Guide modal -->
<dialog id="guide">
  <div class="modal">
    <div class="hd">
      <div><strong>Quick Guide</strong></div>
      <button class="ghost" id="closeGuide">✕</button>
    </div>
    <div class="bd" id="guideBody" style="min-height:120px"></div>
    <div class="ft">
      <div class="row">
        <button class="ghost" id="prevStep">◀ Prev</button>
        <button class="ghost" id="nextStep">Next ▶</button>
      </div>
      <div class="row">
        <button class="btn primary" id="startOne">Do a one‑click turn</button>
        <button class="ghost" id="dismiss">Dismiss</button>
      </div>
    </div>
  </div>
</dialog>

<script type="module">
/* Seeded RNG */
class RNG{constructor(seed=123456789){this.s=seed>>>0}next(){let x=this.s;x^=x<<13;x^=x>>>17;x^=x<<5;this.s=x>>>0;return this.s/0xffffffff}pick(a){return a[Math.floor(this.next()*a.length)]}}

const ruleset={
  meta:{
    site:"Wylfa (Ynys Môn, North Wales)",
    vendor:"Rolls‑Royce SMR (~470–480 MWe each)",
    initialUnits:3,potentialUnits:8,
    regulators:["ONR","Environment Agency","NRW"],
    deliveryBody:"Great British Energy – Nuclear (GBE‑N)",
    gda:{steps:["Step 1 – Initiation","Step 2 – Fundamental Assessment","Step 3 – Detailed Assessment"],endpoint:["ONR – DAC","EA – SoDA"]},
    financingPaths:["GBE‑N public equity","Optional RAB designation → Ofgem revenue collection"],
    targets:{startQuarter:"Q1‑2026",targetFID:"Q4‑2028",targetFirstPower:"Mid‑2030s"}
  },
  init:{quarter:0,cashPublic:2500,cashPrivate:0,rabDesignated:false,gbeNEquitySecured:true,
        gdaStep:2,gdaProgress:0,complianceRisk:15,publicSupport:62,scheduleSlipQ:0,
        longLeadOrdered:false,enablingWorks:false,fidTaken:false,units:3},
  actions:[
    {id:"gda_deepen",name:"Advance GDA Step 3 package",desc:"Fund safety/security/environment workstreams; close queries; mature evidence base.",
     cost:80,months:3,req:s=>s.gdaStep===3||(s.gdaStep===2&&s.gdaProgress>=100),
     effect:s=>{s.gdaStep=3;s.gdaProgress=Math.min(100,s.gdaProgress+18);s.complianceRisk=Math.max(0,s.complianceRisk-2)}},
    {id:"address_findings",name:"Address ONR/EA 'findings'",desc:"Resolve assessment findings to avoid step‑backs or DAC/SoDA caveats.",
     cost:45,months:3,req:s=>s.gdaStep>=2,
     effect:s=>{s.complianceRisk=Math.max(0,s.complianceRisk-6);s.gdaProgress=Math.min(100,s.gdaProgress+6)}},
    {id:"nrw_consult",name:"EA/NRW consultation & community engagement",desc:"Formal consultations + community benefits refresh to maintain local support.",
     cost:30,months:3,req:s=>s.gdaStep>=2,
     effect:s=>{s.publicSupport=Math.min(100,s.publicSupport+5);s.complianceRisk=Math.max(0,s.complianceRisk-1)}},
    {id:"apply_rab",name:"Prepare RAB designation case",desc:"Develop dossier: need, value‑for‑money, deliverability.",
     cost:25,months:3,req:s=>!s.rabDesignated&&s.gdaStep>=2,effect:s=>{s.complianceRisk=Math.max(0,s.complianceRisk-1);s._rabReady=true}},
    {id:"seek_designation",name:"Seek RAB designation (ministerial)",desc:"If approved: Ofgem licence & revenue collection begin.",
     cost:0,months:0,req:s=>s._rabReady&&s.publicSupport>=55,effect:s=>{s._rabVote=true}},
    {id:"gbeN_topup",name:"GBE‑N equity top‑up",desc:"Additional public equity tranche to de‑risk FID.",
     cost:0,months:0,req:s=>true,effect:s=>{s.cashPublic+=350}},
    {id:"long_lead",name:"Place long‑lead factory orders",desc:"Reserve SMR factory capacity; reduces supply‑chain slippage.",
     cost:200,months:0,req:s=>s.gdaStep>=2&&!s.longLeadOrdered&&s.gbeNEquitySecured,
     effect:s=>{s.longLeadOrdered=true;s.scheduleSlipQ=Math.max(0,s.scheduleSlipQ-1)}},
    {id:"enabling",name:"Start enabling works",desc:"Site prep & infrastructure (subject to planning/licences).",
     cost:120,months:3,req:s=>s.gdaStep>=2,effect:s=>{s.enablingWorks=true}},
    {id:"expand_scope",name:"Scope expansion (+1 unit)",desc:"Assess a fourth unit (policy & infra dependent).",
     cost:10,months:0,req:s=>s.units<8&&s.publicSupport>=60&&s.gdaStep>=3,
     effect:s=>{s.units+=1;s.publicSupport=Math.max(0,s.publicSupport-2)}},
    {id:"take_fid",name:"Final Investment Decision",desc:"Needs regulatory readiness and funding headroom.",
     cost:0,months:0,req:s=>!s.fidTaken&&s.gdaStep===3&&s.gdaProgress>=85&&(s.cashPublic+s.cashPrivate)>=(1500+s.units*600),
     effect:s=>{s.fidTaken=true}}
  ],
  events:[
    {id:"onr_issue",label:"ONR raises a GDA issue",prob:s=>Math.max(.05,s.complianceRisk/120),
     effect:s=>{s.gdaProgress=Math.max(0,s.gdaProgress-4);s.complianceRisk=Math.min(100,s.complianceRisk+3);log("ONR query → extra analysis required (−4% progress, +3 risk).","warn")}},
    {id:"supply_bottleneck",label:"Global supply‑chain bottleneck",prob:s=>s.longLeadOrdered?.03:.12,
     effect:s=>{s.scheduleSlipQ+=1;log("Supply chain tight → +1 quarter slip.","warn")}},
    {id:"engagement_pushback",label:"Local pushback / consultation challenge",prob:s=>(s.publicSupport<55)?.12:.05,
     effect:s=>{s.publicSupport=Math.max(0,s.publicSupport-4);s.complianceRisk=Math.min(100,s.complianceRisk+2);log("Stakeholder concerns → support −4, risk +2.","warn")}},
    {id:"inflation_shock",label:"Construction inflation uptick",prob:s=>.06,
     effect:s=>{const extra=40;s.cashPublic=Math.max(0,s.cashPublic-extra);log(`Inflation pressure → unplanned spend £${extra}m.`,"warn")}},
    {id:"diplomatic_noise",label:"International political pressure",prob:s=>.05,
     effect:s=>{if(!s.rabDesignated) s.publicSupport=Math.max(0,s.publicSupport-2);log("Diplomatic cross‑winds → support −2 (narrative risk).","warn")}}
  ]
};

/* --- State & helpers --- */
const QTRS=["Q1","Q2","Q3","Q4"]; const START_YEAR=2026; const TARGET_FP_YEAR=2036; const TARGET_FID_Q=3;
let rng=new RNG(0xC0FFEE); const state=structuredClone(ruleset.init);

function nowQuarter(){const q=state.quarter%4;const y=START_YEAR+Math.floor(state.quarter/4);return `${QTRS[q]}‑${y}`}
function setSeed(s){rng=new RNG(s>>>0);document.getElementById("seedBadge").textContent=`${s>>>0}`}
function log(msg,kind="ok"){const el=document.getElementById("log");const pill=kind==="ok"?"ok":kind==="warn"?"warn":"bad";const line=document.createElement("div");line.innerHTML=`<span class="pill ${pill}">${nowQuarter()}</span> ${msg}`;el.prepend(line)}
function fmtMoney(m){return `£${Math.round(m)}m`} function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}

function estimateLCOE(s){
  const netCap=s.units*480, cf=.9, gen=netCap*8760*cf/1e3;
  const capex=3500+s.units*2200; const wacc=s.rabDesignated?.05:.08;
  const crf=(wacc*Math.pow(1+wacc,40))/(Math.pow(1+wacc,40)-1);
  const annCap=capex*crf, fom=s.units*60, lcoe=(annCap+fom)/gen*1000;
  return Math.round(lcoe)
}
function consumerImpact(s){
  if(!s.rabDesignated) return "—";
  const buildYears=8+Math.round(s.scheduleSlipQ/4);
  const avgBill=1+(s.units*.6)/buildYears; return `£${avgBill.toFixed(2)}/mo during build (proxy)`
}
function progressPct(s){const totalQ=(TARGET_FP_YEAR-START_YEAR)*4;return clamp(Math.min(100,Math.round((s.quarter/(totalQ+s.scheduleSlipQ))*100)),0,100)}
function affordable(cost){return state.cashPublic+state.cashPrivate>=cost}
function spend(cost){let c=cost;const take=Math.min(state.cashPublic,c);state.cashPublic-=take;c-=take;if(c>0) state.cashPrivate=Math.max(0,state.cashPrivate-c)}

/* --- Explain content --- */
const EXPLAIN={
  metric_gda:{t:"GDA progress",b:"The UK Generic Design Assessment (GDA) is a multi‑year, three‑step review by ONR/EA/NRW. Step 3 is detailed assessment; the end point is ONR’s DAC and EA’s SoDA."},
  metric_risk:{t:"Compliance risk",b:"Proxy for technical, safety, security and environmental unknowns. Higher risk increases chances of ONR issues and delays."},
  metric_support:{t:"Public support",b:"Blended local/regional/national sentiment. It affects political decisions such as RAB designation and planning momentum."},
  metric_cashpub:{t:"Public capital (GBE‑N)",b:"Indicative public equity controlled by Great British Energy – Nuclear to co‑fund the programme."},
  metric_cashpriv:{t:"Private capital",b:"Illustrative investor interest that strengthens as risk falls and RAB/design readiness improves."},
  metric_rab:{t:"RAB designated",b:"Under the Nuclear Energy (Financing) Act 2022, a project can be designated for the Regulated Asset Base model, enabling revenue collection during construction."},
  metric_units:{t:"Units in scope",b:"Initial plan is three RR SMRs at Wylfa, with potential ultimately up to eight (subject to policy, finance and infrastructure)."},
  metric_slip:{t:"Schedule slip",b:"Cumulative quarters of delay from supply‑chain or regulatory events. Long‑lead orders help push this down."},
  metric_lcoe:{t:"LCOE (proxy)",b:"Stylised cost per MWh. RAB reduces WACC (financing cost), which lowers this proxy."},
  metric_consumer:{t:"Consumer impact (proxy)",b:"If RAB is used, households pay a small charge during construction; this simple proxy shows order of magnitude only."},
  metric_longlead:{t:"Long‑lead orders",b:"Factory slots for modules, forgings and major components. Early ordering reduces later bottlenecks."},
  metric_enable:{t:"Enabling works",b:"Site preparation and enabling infrastructure (roadworks, earthworks, services)."},
  metric_fid:{t:"FID",b:"Final Investment Decision – the formal go/no‑go to build. Needs regulatory readiness and funding headroom."},
  action_tip:{t:"How actions work",b:"Each action costs money. Some consume ~3 months (advancing the calendar); others are instant. You usually make one or two moves, then advance the quarter."}
}

/* --- Rendering --- */
function render(){
  document.getElementById("clock").textContent=nowQuarter();
  document.getElementById("startQ").textContent=ruleset.meta.targets.startQuarter;
  document.getElementById("targetFID").textContent=ruleset.meta.targets.targetFID;
  document.getElementById("targetFP").textContent=ruleset.meta.targets.targetFirstPower;
  document.getElementById("progress").style.width=progressPct(state)+"%";

  const metrics=[
    {k:"GDA", v:(state.gdaStep===3?"Step 3":state.gdaStep===2?"Step 2":"Step 1")+` • ${state.gdaProgress}%`, key:"metric_gda"},
    {k:"Compliance risk", v:`${state.complianceRisk}/100`, badge:state.complianceRisk<25?"ok":(state.complianceRisk<50?"warn":"bad"), key:"metric_risk"},
    {k:"Public support", v:`${state.publicSupport}%`, badge:state.publicSupport>=60?"ok":(state.publicSupport>=45?"warn":"bad"), key:"metric_support"},
    {k:"Cash (public)", v:fmtMoney(state.cashPublic), key:"metric_cashpub"},
    {k:"Cash (private)", v:fmtMoney(state.cashPrivate), key:"metric_cashpriv"},
    {k:"RAB designated", v:state.rabDesignated?"Yes":"No", key:"metric_rab"},
    {k:"Units (scope)", v:`${state.units}`, key:"metric_units"},
    {k:"Schedule slip", v:`${state.scheduleSlipQ} qtrs`, key:"metric_slip"},
    {k:"LCOE (proxy)", v:`£${estimateLCOE(state)}/MWh`, key:"metric_lcoe"},
    {k:"Consumer impact", v:consumerImpact(state), key:"metric_consumer"},
    {k:"Long‑lead", v:state.longLeadOrdered?"Ordered":"Not yet", key:"metric_longlead"},
    {k:"Enabling works", v:state.enablingWorks?"Underway":"Not started", key:"metric_enable"},
    {k:"FID", v:state.fidTaken?"Taken":"Pending", badge:state.fidTaken?"ok":undefined, key:"metric_fid"}
  ];

  const metEl=document.getElementById("metrics"); metEl.innerHTML="";
  metrics.forEach(m=>{
    const el=document.createElement("div"); el.className="metric";
    el.innerHTML=`<div>
        <div class="k">${m.k}</div>
        <div class="v">${m.v} ${m.badge?`<span class="pill ${m.badge}" style="margin-left:6px">${m.badge.toUpperCase()}</span>`:""}</div>
      </div>
      <button class="ico" title="Explain" data-explain="${m.key}">ⓘ</button>`;
    metEl.appendChild(el);
  });
  metEl.querySelectorAll(".ico").forEach(btn=>btn.addEventListener("click",()=>openExplain(btn.dataset.explain)));

  // Actions
  const actionsEl=document.getElementById("actions"); actionsEl.innerHTML="";
  ruleset.actions.forEach(a=>{
    const enabled=a.req(state), afford=(a.cost===0)||affordable(a.cost), disabled=!(enabled&&afford);
    const card=document.createElement("div"); card.className="action";
    card.innerHTML=`
      <div>
        <div class="name">${a.name}</div>
        <div class="desc">${a.desc}</div>
        <div class="chips">
          ${a.cost?`<span class="chip">Cost ${fmtMoney(a.cost)}</span>`:""}
          ${a.months?`<span class="chip">${a.months} months</span>`:""}
          <span class="chip muted">ⓘ Explain</span>
        </div>
      </div>
      <div class="right">
        <div class="row">
          <button class="ghost iconbtn explain" title="Explain">ⓘ</button>
          <button ${disabled?"disabled":""}>Do it</button>
        </div>
      </div>`;
    card.querySelector("button:not(.explain)").addEventListener("click",()=>applyAction(a));
    card.querySelector(".explain").addEventListener("click",()=>openExplain("action_tip",a.name));
    actionsEl.appendChild(card);
  });

  document.getElementById("rulesText").textContent=JSON.stringify(ruleset,null,2);
}

/* --- Actions & turns --- */
function applyAction(a){
  if(!a.req(state)) return;
  if(a.cost>0 && !affordable(a.cost)){ log(`Insufficient funds for "${a.name}".`,"bad"); return; }
  if(a.cost>0) spend(a.cost);
  a.effect(state);
  const months=a.months??0, qAdv=Math.ceil(months/3);
  if(qAdv>0) state.quarter+=qAdv; // (Note: months time doesn't trigger events; endQuarter does)
  log(`Action: ${a.name} ${a.cost>0?`(spent ${fmtMoney(a.cost)})`:""}`);
  render();
}

function endQuarter(){
  // Programme burn
  const base=35+(state.gdaStep>=3?15:0)+(state.enablingWorks?20:0); spend(base);
  // Random events
  for(const ev of ruleset.events){ if(rng.next()<ev.prob(state)) ev.effect(state) }
  // RAB designation vote if queued
  if(state._rabVote){
    const approval=(state.publicSupport>=60?0.7:0.45)*(state.complianceRisk<20?1.2:1.0);
    if(rng.next()<approval){ state.rabDesignated=true; log("RAB designation approved → Ofgem mechanics start; WACC proxy reduced.","ok"); }
    else{ log("RAB designation not approved this attempt. Strengthen the case & support.","warn"); }
    state._rabVote=false;
  }
  // Private capital formation
  if(state.rabDesignated || (state.gdaStep===3 && state.gdaProgress>80)){ state.cashPrivate+=120 }
  // Notifications
  if(state.gdaStep===3 && state.gdaProgress>=100){ log("GDA Step 3 complete → regulators consider DAC (ONR) & SoDA (EA).","ok") }
  // Construction tuning post‑FID
  if(state.fidTaken){ state.scheduleSlipQ=Math.max(0,state.scheduleSlipQ-(state.longLeadOrdered?.1:0)) }
  state.quarter+=1; render();
}

/* --- Recommendation engine for One‑click Turn --- */
function recommendAction(){
  const A=ruleset.actions;
  const tryDo=id=>{
    const a=A.find(x=>x.id===id);
    if(a && a.req(state) && (a.cost===0 || affordable(a.cost))) return a;
    return null;
  };

  // Priorities:
  if(state.gdaStep<3 || state.gdaProgress<85) return tryDo("gda_deepen")||tryDo("address_findings")||tryDo("nrw_consult");
  if(!state._rabReady && !state.rabDesignated) return tryDo("apply_rab");
  if(state._rabReady && !state.rabDesignated && state.publicSupport>=55) return tryDo("seek_designation");
  if(!state.longLeadOrdered) return tryDo("long_lead");
  if(!state.enablingWorks) return tryDo("enabling");
  if((state.cashPublic+state.cashPrivate)<(1500+state.units*600)) return tryDo("gbeN_topup");
  if(!state.fidTaken && state.gdaProgress>=85) return tryDo("take_fid");
  if(state.units<4) return tryDo("expand_scope");
  return null;
}

/* One‑click turn: apply recommendation; if the chosen action consumed time (months>0), we DO NOT also endQuarter; otherwise we endQuarter */
function oneClickTurn(){
  const rec=recommendAction();
  if(rec){ const hadQ=state.quarter; applyAction(rec);
    const months=rec.months??0;
    if(months===0) endQuarter();
    else log("Time advanced by action; press Space to process events for next quarter.","warn");
  } else {
    log("No obvious recommended action → advancing a quarter.","warn"); endQuarter();
  }
}

/* --- Save/Load/Reset --- */
function saveState(){
  const blob=new Blob([JSON.stringify({state,seed:rng.s},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download=`wylfa-sim-save-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
}
function loadState(){
  const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json";
  inp.onchange=e=>{
    const f=e.target.files[0]; if(!f) return; const fr=new FileReader();
    fr.onload=()=>{ try{ const o=JSON.parse(fr.result); Object.assign(state,o.state||{}); setSeed((o.seed??0)>>>0); log("Loaded save file.","ok"); render(); }catch{ log("Failed to load save file.","bad") } };
    fr.readAsText(f);
  }; inp.click();
}
function resetAll(){ Object.assign(state,structuredClone(ruleset.init)); setSeed(0xC0FFEE); document.getElementById("log").innerHTML=""; log("Reset simulation."); render(); }

/* --- UI wiring --- */
document.getElementById("endTurn").addEventListener("click",endQuarter);
document.getElementById("saveBtn").addEventListener("click",saveState);
document.getElementById("loadBtn").addEventListener("click",loadState);
document.getElementById("resetBtn").addEventListener("click",resetAll);
document.getElementById("oneClickBtn").addEventListener("click",oneClickTurn);
document.getElementById("auto4").addEventListener("click",()=>autoRun(4));
document.getElementById("autoYear").addEventListener("click",()=>autoRun(4));
document.getElementById("compactBtn").addEventListener("click",()=>document.body.classList.toggle("compact"));

/* Keyboard shortcuts */
window.addEventListener("keydown",e=>{
  const tag=e.target.tagName.toLowerCase();
  if(tag==="input"||tag==="textarea") return;
  if(e.key===" "){ e.preventDefault(); endQuarter(); }
  else if(e.key.toLowerCase()==="a"){ e.preventDefault(); oneClickTurn(); }
  else if(e.key.toLowerCase()==="r"){ resetAll() }
  else if(e.key.toLowerCase()==="s"){ saveState() }
  else if(e.key.toLowerCase()==="l"){ loadState() }
  else if(e.key==="?"){ e.preventDefault(); openGuide() }
});

/* Auto‑run helper */
let autoRunning=false;
async function autoRun(qtrs){
  if(autoRunning) return; autoRunning=true;
  for(let i=0;i<qtrs;i++){ endQuarter(); await new Promise(r=>setTimeout(r,120)); }
  autoRunning=false;
}

/* Explainer popover */
const pop=document.getElementById("popover"), popTitle=document.getElementById("popTitle"), popBody=document.getElementById("popBody");
document.getElementById("popClose").addEventListener("click",()=>pop.style.display="none");
function openExplain(key,overrideTitle){
  const e=EXPLAIN[key]; if(!e) return;
  popTitle.textContent=overrideTitle||e.t; popBody.textContent=e.b; pop.style.display="block";
  // simple placement: bottom-right; could be extended to anchor to element if needed
}

/* Quick Guide (wizard) */
const guide=document.getElementById("guide"), guideBody=document.getElementById("guideBody");
const steps=[
  {t:"Welcome",b:`Goal: steer the UK's first SMR site at Wylfa from design assessment to FID and first power in the 2030s. Each quarter you pick actions, manage risks, and secure finance.`},
  {t:"Regulation (GDA)",b:`GDA has 3 steps. You're entering Step 3 (detailed assessment). Finish Step 3 to reach DAC (ONR) and SoDA (EA). Keep compliance risk low by addressing findings.`},
  {t:"Financing",b:`Baseline is GBE‑N public equity. You may also pursue RAB designation to reduce financing cost and start revenue collection during construction.`},
  {t:"Metrics & risk",b:`Watch public support, compliance risk, schedule slip and LCOE (proxy). Random events can nudge each metric; mitigate with long‑lead orders and engagement.`},
  {t:"Play loop",b:`Use <A> One‑click Turn for a smart move, then <Space> for the next quarter. You can Auto‑run a few quarters anytime.`}
];
let step=0; function renderStep(){guideBody.innerHTML=`<h3 style="margin:.1rem 0">${steps[step].t}</h3><p class="muted" style="margin:.2rem 0 0">${steps[step].b}</p>`}
function openGuide(){ renderStep(); guide.showModal(); }
document.getElementById("quickGuideBtn").addEventListener("click",openGuide);
document.getElementById("closeGuide").addEventListener("click",()=>guide.close());
document.getElementById("dismiss").addEventListener("click",()=>guide.close());
document.getElementById("prevStep").addEventListener("click",()=>{step=Math.max(0,step-1);renderStep()});
document.getElementById("nextStep").addEventListener("click",()=>{step=Math.min(steps.length-1,step+1);renderStep()});
document.getElementById("startOne").addEventListener("click",()=>{guide.close(); oneClickTurn()});

/* Boot */
setSeed(0xC0FFEE);
log("Welcome. Hit ? for the Quick Guide, A for a one‑click turn, Space for next quarter.");
render();
openGuide(); // show once on load
</script>
</body>
</html>
