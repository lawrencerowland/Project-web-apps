<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Date Defense Kit — Monte Carlo for Uncertain Projects</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --accent:#4cc9f0; --ink:#e6edf3; --muted:#9fb2c8; --warn:#ffb703; --good:#80ed99; --bad:#ff6b6b;
    --grid:#1f2833; --chip:#1b2330; --focus:#94d2bd;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    --sans: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0a0d12, #0b111a 40%, #0a0f17);
    color:var(--ink); font-family:var(--sans); line-height:1.35;
  }
  header{
    position:sticky; top:0; z-index:3;
    background:rgba(10,14,20,.9); backdrop-filter: blur(6px);
    border-bottom:1px solid #15202b;
  }
  header .wrap{display:flex; align-items:center; gap:12px; padding:12px 16px}
  h1{font-size:18px; margin:0;}
  .tag{font-size:12px; color:var(--muted); background:var(--chip); border:1px solid #2a3545; padding:3px 8px; border-radius:999px}
  main{max-width:1200px; margin:24px auto; padding:0 16px 64px}
  .grid{display:grid; gap:16px}
  @media(min-width:1000px){ .grid{grid-template-columns:420px 1fr} }
  section.card{
    background:linear-gradient(180deg,#0f1622,#0e1520);
    border:1px solid #1c2736; border-radius:12px; overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02);
  }
  section.card header{background:transparent; position:static; border:0}
  section.card h2{font-size:16px; margin:0; padding:12px 14px; border-bottom:1px solid #1b2533}
  section.card .body{padding:12px}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  input[type="text"], input[type="number"], select, input[type="date"]{
    width:100%; padding:8px 10px; background:#0b1220; color:var(--ink);
    border:1px solid #22314a; border-radius:8px; outline:none;
  }
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0;}
  input:focus, select:focus{border-color:var(--focus); box-shadow:0 0 0 2px rgba(148,210,189,.15)}
  .row{display:grid; gap:12px; grid-template-columns:repeat(12,1fr)}
  .row > div[col]{grid-column:span var(--col)}
  .btn{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; cursor:pointer; user-select:none;
    color:var(--ink); background:#152033; border:1px solid #25344a;
  }
  .btn:hover{background:#17243a}
  .btn.primary{background:linear-gradient(180deg,#1c2f4b,#183150); border-color:#2c476b}
  .btn.danger{background:linear-gradient(180deg,#3a1b1b,#421a1a); border-color:#5a2525}
  .btn.ghost{background:transparent; border-color:#2a3b53}
  .btn.small{font-size:12px; padding:6px 10px}
  table{width:100%; border-collapse:separate; border-spacing:0 8px}
  thead th{font-size:12px; text-align:left; color:#8aa0b8; padding:6px 8px}
  tbody td{background:#0b1220; border:1px solid #22314a; padding:6px 8px; font-size:13px}
  tbody tr td:first-child{border-top-left-radius:8px; border-bottom-left-radius:8px}
  tbody tr td:last-child{border-top-right-radius:8px; border-bottom-right-radius:8px}
  td .chip{font-size:11px; padding:2px 6px; background:#111a2a; border:1px solid #26344a; border-radius:6px; color:#bcd;}
  td input{width:100%; background:transparent; border:0; color:var(--ink); outline:none}
  td input::placeholder{color:#6c7e95}
  .muted{color:var(--muted)}
  .sep{height:1px; background:#1b2533; margin:10px 0}
  .canvaswrap{position:relative; background:#0b1220; border:1px solid #22314a; border-radius:12px; padding:8px}
  canvas{display:block; width:100%; height:260px; background:repeating-linear-gradient(0deg,var(--grid),var(--grid) 1px, transparent 1px, transparent 20px);}
  .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  .kpi .box{background:#0b1220; border:1px solid #22314a; border-radius:10px; padding:10px}
  .kpi .box h3{margin:0; font-size:12px; color:#9ab}
  .kpi .box div{font-family:var(--mono); font-size:18px; margin-top:6px}
  .pill{display:inline-flex; align-items:center; gap:6px; background:#102033; border:1px solid #263b56; color:#c8e; padding:4px 8px; border-radius:999px; font-size:12px}
  details{border:1px dashed #2a3a52; border-radius:8px; padding:8px 10px; background:#0a1322}
  summary{cursor:pointer; color:#b7c7db}
  .progress{height:8px; background:#112033; border:1px solid #22314a; border-radius:999px; overflow:hidden}
  .progress > div{height:100%; background:linear-gradient(90deg,#2dd4bf,#60a5fa); width:0%}
  .note{font-size:12px; color:#9ab}
  .footer{margin-top:18px; font-size:12px; color:#8aa0b8}
  .link{color:#93c5fd; text-decoration:none; border-bottom:1px dotted #93c5fd}
  .right{float:right}
  .center{display:flex; align-items:center; justify-content:center}
  .kbd{font-family:var(--mono); background:#101826; border:1px solid #28364a; padding:2px 6px; border-radius:5px}
  .warn{color:var(--warn)}
  .good{color:var(--good)}
  .bad{color:var(--bad)}
  .nowrap{white-space:nowrap}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Date Defense Kit <span class="tag">Monte Carlo • PERT • Criticality</span></h1>
    <div class="tag">For discovery-heavy PMs who must defend dates under uncertainty</div>
    <div class="right" style="margin-left:auto; display:flex; gap:8px">
      <button class="btn small ghost" id="btnLoadExample">Load example</button>
      <button class="btn small ghost" id="btnSave">Save</button>
      <button class="btn small ghost" id="btnShare">Share link</button>
      <button class="btn small ghost danger" id="btnReset">Reset</button>
    </div>
  </div>
</header>

<main class="grid">
  <!-- LEFT: Inputs -->
  <section class="card">
    <h2>1) Define Work & Uncertainty</h2>
    <div class="body">
      <div class="row" style="margin-bottom:8px">
        <div col style="--col:6">
          <label>Project start date</label>
          <input type="date" id="startDate" />
        </div>
        <div col style="--col:3">
          <label>Iterations (Monte Carlo)</label>
          <input type="number" id="iterations" min="100" step="100" value="5000" />
        </div>
        <div col style="--col:3">
          <label>Distribution</label>
          <select id="distType">
            <option value="pert">Beta‑PERT (λ=4)</option>
            <option value="tri">Triangular</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <div col style="--col:6">
          <label>Assume durations are in</label>
          <select id="timeUnit">
            <option value="days" selected>Days (calendar)</option>
            <option value="wdays">Working days (skip weekends)</option>
          </select>
        </div>
        <div col style="--col:6">
          <label class="muted">Hint</label>
          <div class="note">Enter <span class="kbd">O</span>/<span class="kbd">M</span>/<span class="kbd">P</span> (optimistic/most‑likely/pessimistic). Dependencies are comma‑separated IDs. All times are nonnegative.</div>
        </div>
      </div>

      <div class="sep"></div>

      <div style="overflow:auto">
        <table id="taskTable">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Group</th>
              <th class="nowrap">O</th><th class="nowrap">M</th><th class="nowrap">P</th>
              <th>Depends on</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="taskTbody">
          </tbody>
        </table>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="btn small" id="btnAddRow">Add task</button>
        <button class="btn small" id="btnBulk">Bulk paste CSV/TSV</button>
        <button class="btn small" id="btnExport">Export JSON</button>
        <input type="file" id="fileImport" accept=".json" style="display:none" />
        <button class="btn small" id="btnImport">Import JSON</button>
      </div>

      <details style="margin-top:10px">
        <summary>Bulk paste format (click to expand)</summary>
        <div class="note" style="margin-top:6px">
          Columns: ID, Name, Group, O, M, P, DependsOn (IDs separated by semicolons). One task per line. Example:<br/>
          <pre class="kbd">T1, Scope spike, Discovery, 1, 2, 4, 
T2, Data contract agreed, Partner, 2, 3, 8, T1
T3, Model training, ML, 3, 6, 14, T1
T4, Backend endpoints, Backend, 2, 5, 9, T1
T5, Integrations, Backend, 3, 5, 12, T2;T4
T6, Frontend UI, Frontend, 2, 4, 8, T4
T7, E2E Test, QA, 2, 3, 6, T5;T6
T8, Pilot rollout, Launch, 1, 2, 5, T3;T7</pre>
        </div>
      </details>
    </div>
  </section>

  <!-- RIGHT: Simulation + Outputs -->
  <section class="card">
    <h2>2) Simulate & Defend Your Date</h2>
    <div class="body">
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn primary" id="btnRun">Run simulation</button>
        <button class="btn" id="btnStop" disabled>Stop</button>
        <div class="progress" style="flex:1; margin-left:8px"><div id="prog"></div></div>
        <div class="pill"><span id="iterLabel">0</span> / <span id="iterTotal">0</span></div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="box"><h3>P50 (days)</h3><div id="kpiP50">—</div></div>
        <div class="box"><h3>P80 (days)</h3><div id="kpiP80">—</div></div>
        <div class="box"><h3>P90 (days)</h3><div id="kpiP90">—</div></div>
        <div class="box"><h3>Mean ± SD</h3><div id="kpiMean">—</div></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div col style="--col:6">
          <label>Forecast completion dates</label>
          <div class="box" style="background:#0b1220; border:1px solid #22314a; border-radius:10px; padding:10px">
            <div>P50: <span id="dateP50" class="kbd">—</span></div>
            <div>P80: <span id="dateP80" class="kbd">—</span></div>
            <div>P90: <span id="dateP90" class="kbd">—</span></div>
          </div>
        </div>
        <div col style="--col:6">
          <label>Suggested project buffer (P90 − P50)</label>
          <div class="box"><div id="bufferSuggest">—</div></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div col style="--col:12">
          <label>Distribution (Histogram & S‑curve)</label>
          <div class="canvaswrap">
            <canvas id="hist"></canvas>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div col style="--col:12">
          <label>Risk salience (criticality × spread)</label>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Task</th><th>Group</th>
                  <th>Criticality index</th><th>Spread (P−O)</th>
                  <th>Score</th>
                </tr>
              </thead>
              <tbody id="insightsTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div col style="--col:12">
          <label>Date‑defense narrative</label>
          <textarea id="narrative" rows="6" style="width:100%; background:#0b1220; color:var(--ink); border:1px solid #22314a; border-radius:10px; padding:10px" placeholder="Run the simulation to generate a defendable paragraph…"></textarea>
          <div class="footer">Copy into status emails. Edits stick to localStorage.</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div col style="--col:12">
          <label>What‑if: crash top risky tasks</label>
          <div class="note">Pick a % reduction applied to the <em>pessimistic</em> (P) for the top three salient tasks, then re‑run quickly.</div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:6px">
            <input type="range" min="0" max="40" value="15" id="whatIfPct" />
            <div class="kbd" id="whatIfLabel">15%</div>
            <button class="btn small" id="btnWhatIf">Apply & simulate</button>
          </div>
        </div>
      </div>

      <div class="footer">
        Uses only the browser; no data leaves your machine. Persisted in <span class="kbd">localStorage</span>.
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  // ---------- Storage & State ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const LS_KEY = 'date_defense_kit_v1';
  const SAMPLES_KEY = 'date_defense_kit_samples';
  const state = {
    tasks: [],
    startDate: null,
    iterations: 5000,
    distType: 'pert',
    timeUnit: 'days',
    results: null, // set after simulation
    lastNarrative: ''
  };

  function saveState(){
    const data = {
      tasks: state.tasks,
      startDate: $('#startDate').value || null,
      iterations: parseInt($('#iterations').value || '5000',10),
      distType: $('#distType').value,
      timeUnit: $('#timeUnit').value,
      narrative: $('#narrative').value
    };
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }
  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ return false; }
    try{
      const data = JSON.parse(raw);
      if(Array.isArray(data.tasks)) state.tasks = data.tasks;
      $('#startDate').value = data.startDate || '';
      $('#iterations').value = data.iterations || 5000;
      $('#distType').value = data.distType || 'pert';
      $('#timeUnit').value = data.timeUnit || 'days';
      $('#narrative').value = data.narrative || '';
      renderTasks();
      return true;
    }catch(e){ console.warn('Bad state', e); return false; }
  }

  // ---------- Task Table ----------
  function renderTasks(){
    const tbody = $('#taskTbody');
    tbody.innerHTML = '';
    if(state.tasks.length === 0){
      addRow({id:'T1', name:'Define problem & scope', group:'Discovery', o:1, m:2, p:4, deps:[]});
      addRow({id:'T2', name:'Data access contract', group:'Partner', o:2, m:3, p:8, deps:['T1']});
      addRow({id:'T3', name:'Model training', group:'ML', o:3, m:6, p:14, deps:['T1']});
      addRow({id:'T4', name:'Backend endpoints', group:'Backend', o:2, m:5, p:9, deps:['T1']});
      addRow({id:'T5', name:'Integrations', group:'Backend', o:3, m:5, p:12, deps:['T2','T4']});
      addRow({id:'T6', name:'Frontend UI', group:'Frontend', o:2, m:4, p:8, deps:['T4']});
      addRow({id:'T7', name:'E2E test', group:'QA', o:2, m:3, p:6, deps:['T5','T6']});
      addRow({id:'T8', name:'Pilot rollout', group:'Launch', o:1, m:2, p:5, deps:['T3','T7']});
      saveState();
      return;
    }
    state.tasks.forEach(t => addRow(t));
  }

  function addRow(t){
    if(!t) t = {id:`T${state.tasks.length+1}`, name:'', group:'', o:1, m:1, p:1, deps:[]};
    state.tasks.push(t);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input data-k="id" value="${escapeHtml(t.id||'')}" /></td>
      <td><input data-k="name" value="${escapeHtml(t.name||'')}" placeholder="Task name"/></td>
      <td><input data-k="group" value="${escapeHtml(t.group||'')}" placeholder="Group"/></td>
      <td><input data-k="o" type="number" min="0" step="0.1" value="${num(t.o,1)}"/></td>
      <td><input data-k="m" type="number" min="0" step="0.1" value="${num(t.m,1)}"/></td>
      <td><input data-k="p" type="number" min="0" step="0.1" value="${num(t.p,1)}"/></td>
      <td><input data-k="deps" value="${(t.deps||[]).join(';')}" placeholder="e.g., T1;T2"/></td>
      <td><button class="btn small danger" data-del>Delete</button></td>
    `;
    $('#taskTbody').appendChild(tr);

    tr.addEventListener('input', (e)=>{
      const input = e.target.closest('input');
      if(!input) return;
      const k = input.getAttribute('data-k');
      const idx = indexOfRow(tr);
      const row = state.tasks[idx];
      if(k==='deps'){
        row.deps = input.value.split(/[;,]+/).map(s=>s.trim()).filter(Boolean);
      } else if(k==='o'||k==='m'||k==='p'){
        row[k] = parseFloat(input.value||'0');
      } else {
        row[k] = input.value;
      }
      saveState();
    });
    tr.querySelector('[data-del]').addEventListener('click', ()=>{
      const idx = indexOfRow(tr);
      state.tasks.splice(idx,1);
      tr.remove();
      saveState();
    });
  }
  function indexOfRow(tr){
    return Array.from($('#taskTbody').children).indexOf(tr);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c])); }
  function num(v, d=1){ const n = (v==null||isNaN(v)) ? 0 : Number(v); return n.toFixed(d); }

  // Bulk paste
  $('#btnBulk').addEventListener('click', ()=>{
    const txt = prompt('Paste CSV/TSV lines:\nID, Name, Group, O, M, P, DependsOnIDs (; separated)');
    if(!txt) return;
    const lines = txt.split(/\r?\n/).filter(Boolean);
    // Clear and rebuild
    state.tasks = [];
    $('#taskTbody').innerHTML = '';
    for(const line of lines){
      const parts = line.split(/,|\t/).map(s=>s.trim());
      if(parts.length < 6) continue;
      const [id,name,group,o,m,p, depsRaw] = [parts[0], parts[1]||'', parts[2]||'', parseFloat(parts[3]||'0'), parseFloat(parts[4]||'0'), parseFloat(parts[5]||'0'), parts[6]||'' ];
      addRow({id,name,group,o,m,p,deps: (depsRaw||'').split(/[;]+/).map(s=>s.trim()).filter(Boolean)});
    }
    saveState();
  });

  // Import/Export/Share
  $('#btnExport').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify({ tasks: state.tasks }, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'date-defense-tasks.json';
    document.body.appendChild(a); a.click(); a.remove();
  });
  $('#btnImport').addEventListener('click', ()=>$('#fileImport').click());
  $('#fileImport').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if(Array.isArray(data.tasks)){
          state.tasks = data.tasks; renderTasks(); saveState();
        }else{ alert('Invalid JSON: expected {"tasks": [...]}'); }
      }catch(err){ alert('Invalid JSON file.'); }
    };
    reader.readAsText(file);
  });

  $('#btnShare').addEventListener('click', ()=>{
    // encode tasks into URL hash (base64 JSON)
    const payload = { tasks: state.tasks, start: $('#startDate').value, dist: $('#distType').value, unit: $('#timeUnit').value };
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const url = location.origin + location.pathname + '#d=' + b64;
    navigator.clipboard.writeText(url).then(()=> alert('Shareable link copied to clipboard.'));
  });

  function tryLoadFromHash(){
    const hash = location.hash;
    const m = hash.match(/#d=([^&]+)/);
    if(!m) return false;
    try{
      const obj = JSON.parse(decodeURIComponent(escape(atob(m[1]))));
      if(Array.isArray(obj.tasks)){
        state.tasks = obj.tasks;
        $('#startDate').value = obj.start || '';
        $('#distType').value = obj.dist || 'pert';
        $('#timeUnit').value = obj.unit || 'days';
        renderTasks(); saveState();
        return true;
      }
    }catch(e){}
    return false;
  }

  // ---------- Simulation Worker ----------
  let worker = null;
  function buildWorker(){
    const code = `
      // --- Random utils ---
      function randn(){ // Box-Muller
        let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
        return Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);
      }
      function gamma(k){
        if(k<=0) return 0;
        if(k<1){
          // Johnk / Ahrens-Dieter transformation
          const c = k; const d = 1.0 - k;
          while(true){
            const u1 = Math.random(), u2 = Math.random();
            const x = Math.pow(u1, 1/c);
            const y = Math.pow(u2, 1/d);
            if(x + y <= 1){
              return -Math.log(Math.random()) * x / (x + y);
            }
          }
        }
        const d = k - 1/3, c = 1/Math.sqrt(9*d);
        while(true){
          let x = randn();
          let v = 1 + c*x; if(v<=0) continue;
          v = v*v*v;
          const u = Math.random();
          if(u < 1 - 0.0331*x*x*x*x) return d*v;
          if(Math.log(u) < 0.5*x*x + d*(1 - v + Math.log(v))) return d*v;
        }
      }
      function beta(a,b){
        const x = gamma(a), y = gamma(b);
        return x/(x+y);
      }
      function samplePERT(o,m,p,lambda=4){
        if(!(p>o)) return m;
        const a = 1 + lambda*(m-o)/(p-o);
        const b = 1 + lambda*(p-m)/(p-o);
        const r = beta(Math.max(1e-6,a), Math.max(1e-6,b));
        return o + r*(p-o);
      }
      function sampleTri(o,m,p){
        if(!(p>o)) return m;
        const u = Math.random();
        const c = (m-o)/(p-o);
        if(u < c) return o + Math.sqrt(u*(p-o)*(m-o));
        return p - Math.sqrt((1-u)*(p-o)*(p-m));
      }

      function topoSort(nodes, deps){
        // Kahn's algorithm
        const indeg = new Map(); const out = new Map();
        nodes.forEach(n=>{indeg.set(n,0); out.set(n,[]);});
        deps.forEach(([a,b])=>{ // a depends on b => edge b->a
          out.get(b).push(a);
          indeg.set(a, indeg.get(a)+1);
        });
        const q=[]; indeg.forEach((v,k)=>{ if(v===0) q.push(k); });
        const order=[];
        while(q.length){
          const n = q.shift(); order.push(n);
          for(const m of out.get(n)){
            indeg.set(m, indeg.get(m)-1);
            if(indeg.get(m)===0) q.push(m);
          }
        }
        if(order.length!==nodes.length) return null;
        return {order, succ: out};
      }

      function scheduleOnce(tasks, distType){
        // tasks: array of {id,o,m,p,deps:[]}
        const ids = tasks.map(t=>t.id);
        const id2i = new Map(ids.map((id,i)=>[id,i]));
        const edges = [];
        for(const t of tasks){
          for(const d of (t.deps||[])){
            if(!id2i.has(d)) return {error:'Dependency '+d+' not found'};
            edges.push([t.id, d]);
          }
        }
        const topo = topoSort(ids, edges);
        if(!topo) return {error:'Cycle detected in dependencies'};
        const n = tasks.length;
        const ES = new Float64Array(n);
        const EF = new Float64Array(n);
        const D  = new Float64Array(n);
        for(const id of topo.order){
          const i = id2i.get(id);
          const t = tasks[i];
          const o=+t.o||0, m=+t.m||0, p=+t.p||0;
          const d = (distType==='pert') ? samplePERT(o,m,p,4) : sampleTri(o,m,p);
          D[i] = d;
          let es = 0;
          for(const dep of (t.deps||[])){
            const j = id2i.get(dep);
            if(EF[j] > es) es = EF[j];
          }
          ES[i] = es; EF[i] = es + d;
        }
        let finish = 0; for(let i=0;i<n;i++){ if(EF[i]>finish) finish=EF[i]; }
        // Latest times via reverse DP
        const LF = new Float64Array(n);
        const LS = new Float64Array(n);
        const succ = topo.succ;
        for(let k=topo.order.length-1;k>=0;k--){
          const id = topo.order[k]; const i = id2i.get(id);
          const out = succ.get(id);
          if(!out || out.length===0){ LF[i]=finish; LS[i]=finish-D[i]; }
          else{
            let minLS = Infinity;
            for(const sId of out){
              const j = id2i.get(sId);
              const lsj = LF[j] - D[j];
              if(lsj < minLS) minLS = lsj;
            }
            LF[i]=minLS; LS[i]=minLS - D[i]; // LS here is not used further
          }
        }
        const crit = new Uint8Array(n);
        for(let i=0;i<n;i++){
          const slack = LF[i] - EF[i];
          if(Math.abs(slack) < 1e-9) crit[i] = 1;
        }
        return {finish, D, crit, EF, ES, order: topo.order, id2i};
      }

      onmessage = async (e)=>{
        const {tasks, iterations, distType, progressEvery} = e.data;
        const n = tasks.length;
        const totals = new Float64Array(iterations);
        const critCount = new Float64Array(n);
        const errAt = (msg)=> postMessage({type:'error', message:msg});
        // pre-validate
        const ids = new Set(tasks.map(t=>t.id));
        for(const t of tasks){
          for(const d of (t.deps||[])){
            if(!ids.has(d)) return errAt('Dependency '+d+' not found');
          }
        }
        // run
        for(let k=0;k<iterations;k++){
          const res = scheduleOnce(tasks, distType);
          if(res.error) return errAt(res.error);
          totals[k] = res.finish;
          for(let i=0;i<n;i++) critCount[i] += res.crit[i];
          if( (k+1)%progressEvery===0 || k===iterations-1 ){
            postMessage({type:'progress', done:k+1, total:iterations});
          }
        }
        // summary stats
        const sorted = Array.from(totals).sort((a,b)=>a-b);
        function quantile(q){
          if(sorted.length===0) return 0;
          const idx = (sorted.length-1)*q;
          const lo = Math.floor(idx), hi = Math.ceil(idx);
          if(lo===hi) return sorted[lo];
          return sorted[lo] + (sorted[hi]-sorted[lo])*(idx-lo);
        }
        let sum=0, sumsq=0, mn=Infinity, mx=-Infinity;
        for(const x of totals){ sum+=x; sumsq+=x*x; if(x<mn)mn=x; if(x>mx)mx=x; }
        const mean = sum/totals.length;
        const sd = Math.sqrt(Math.max(0, sumsq/totals.length - mean*mean));
        // Task salience score = criticality * spread
        const spread = tasks.map(t => Math.max(0,(+t.p||0)-(+t.o||0)));
        const critIdx = Array.from(critCount).map(c=> c/iterations);
        const scores = critIdx.map((c,i)=> c * spread[i]);
        postMessage({
          type:'done',
          totals: Array.from(totals),
          stats: {p50: quantile(0.50), p80: quantile(0.80), p90: quantile(0.90), p95: quantile(0.95), mean, sd, min:mn, max:mx},
          critIdx, spread, scores
        });
      };
    `;
    const blob = new Blob([code], {type:'application/javascript'});
    return new Worker(URL.createObjectURL(blob));
  }

  function runSimulation(modifiedTasks=null, quick=false){
    const tasks = (modifiedTasks || collectTasks());
    if(tasks.length===0){ alert('Add at least one task.'); return; }
    const iterations = parseInt($('#iterations').value||'5000',10);
    const distType = $('#distType').value;
    $('#btnRun').disabled = true; $('#btnStop').disabled = false;
    $('#iterLabel').textContent = '0'; $('#iterTotal').textContent = String(iterations);
    $('#prog').style.width = '0%';
    worker?.terminate(); worker = buildWorker();

    worker.onmessage = (e)=>{
      const msg = e.data;
      if(msg.type==='error'){ alert(msg.message); $('#btnRun').disabled=false; $('#btnStop').disabled=true; return; }
      if(msg.type==='progress'){
        $('#iterLabel').textContent = String(msg.done);
        $('#prog').style.width = (100*msg.done/msg.total).toFixed(1)+'%';
      }
      if(msg.type==='done'){
        $('#btnRun').disabled=false; $('#btnStop').disabled=true;
        state.results = { totals: msg.totals, stats: msg.stats, critIdx: msg.critIdx, spread: msg.spread, scores: msg.scores, tasks: tasks };
        updateKPIs();
        drawHist();
        renderInsights();
        generateNarrative();
        saveState();
      }
    };
    worker.postMessage({ tasks, iterations, distType, progressEvery: Math.max(50, Math.round(iterations/40)) });
  }

  $('#btnRun').addEventListener('click', ()=> runSimulation());
  $('#btnStop').addEventListener('click', ()=> { worker?.terminate(); $('#btnRun').disabled=false; $('#btnStop').disabled=true; });

  function collectTasks(){
    const rows = $$('#taskTbody tr');
    const ids = new Set();
    const tasks = [];
    for(const tr of rows){
      const cell = k => tr.querySelector('input[data-k="'+k+'"]');
      const id = (cell('id').value||'').trim();
      if(!id) { alert('Each task needs an ID.'); return []; }
      if(ids.has(id)) { alert('Duplicate ID: '+id); return []; }
      ids.add(id);
      const name = cell('name').value||'';
      const group = cell('group').value||'';
      const o = parseFloat(cell('o').value||'0');
      const m = parseFloat(cell('m').value||'0');
      const p = parseFloat(cell('p').value||'0');
      if(!(o<=m && m<=p)){ alert('O ≤ M ≤ P violated for '+id); return []; }
      const deps = (cell('deps').value||'').split(/[;,\s]+/).map(s=>s.trim()).filter(Boolean);
      tasks.push({id,name,group,o,m,p,deps});
    }
    return tasks;
  }

  // ---------- KPIs ----------
  function updateKPIs(){
    if(!state.results) return;
    const s = state.results.stats;
    $('#kpiP50').textContent = s.p50.toFixed(1);
    $('#kpiP80').textContent = s.p80.toFixed(1);
    $('#kpiP90').textContent = s.p90.toFixed(1);
    $('#kpiMean').textContent = `${s.mean.toFixed(1)} ± ${s.sd.toFixed(1)}`;
    const startStr = $('#startDate').value || '';
    const unit = $('#timeUnit').value;
    const p50date = startStr ? addDaysHuman(startStr, s.p50, unit) : '—';
    const p80date = startStr ? addDaysHuman(startStr, s.p80, unit) : '—';
    const p90date = startStr ? addDaysHuman(startStr, s.p90, unit) : '—';
    $('#dateP50').textContent = p50date;
    $('#dateP80').textContent = p80date;
    $('#dateP90').textContent = p90date;
    $('#bufferSuggest').textContent = (s.p90 - s.p50).toFixed(1) + ' ' + ($('#timeUnit').value==='wdays'?'working days':'days');
  }

  function addDaysHuman(startDateStr, days, unit){
    const d = new Date(startDateStr+'T12:00:00'); // midday to avoid DST edge
    if(unit==='wdays'){
      let remaining = Math.ceil(days);
      while(remaining>0){
        d.setDate(d.getDate()+1);
        const day = d.getDay();
        if(day!==0 && day!==6) remaining--;
      }
    }else{
      d.setDate(d.getDate() + Math.ceil(days));
    }
    return d.toLocaleDateString();
  }

  // ---------- Histogram + S-curve ----------
  function drawHist(){
    const canvas = $('#hist');
    const ctx = canvas.getContext('2d');
    const W = canvas.clientWidth, H = canvas.clientHeight;
    canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio; ctx.scale(devicePixelRatio, devicePixelRatio);
    ctx.clearRect(0,0,W,H);
    if(!state.results || !state.results.totals?.length){ return; }
    const data = state.results.totals.slice();
    data.sort((a,b)=>a-b);
    const n = data.length;
    const min = data[0], max = data[n-1];
    const bins = Math.min(40, Math.ceil(Math.sqrt(n)));
    const binW = (max-min)/bins || 1;
    const counts = new Array(bins).fill(0);
    for(const x of data){
      let b = Math.floor((x-min)/binW);
      if(b>=bins) b=bins-1;
      counts[b]++;
    }
    const maxCount = Math.max(...counts);

    // axes
    const padL = 40, padR = 16, padB = 22, padT = 8;
    const plotW = W - padL - padR, plotH = H - padT - padB;

    // histogram bars
    ctx.fillStyle = '#1f3b57';
    for(let i=0;i<bins;i++){
      const x0 = padL + i*plotW/bins + 1;
      const h = Math.round((counts[i]/maxCount)*plotH);
      const y0 = padT + plotH - h;
      const bw = Math.max(1, plotW/bins - 2);
      ctx.fillRect(x0, y0, bw, h);
    }

    // S-curve
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const x = padL + ( (data[i]-min)/(max-min) ) * plotW;
      const y = padT + plotH - (i/(n-1))*plotH;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.lineWidth = 2; ctx.strokeStyle = '#83c5be'; ctx.stroke();

    // percentile markers
    const s = state.results.stats;
    const marks = [
      {label:'P50', val:s.p50, color:'#e9c46a'},
      {label:'P80', val:s.p80, color:'#f4a261'},
      {label:'P90', val:s.p90, color:'#e76f51'}
    ];
    ctx.textAlign='center'; ctx.textBaseline='top'; ctx.font='12px ' + getComputedStyle(document.body).fontFamily;
    marks.forEach(m=>{
      const x = padL + ((m.val - min)/(max-min))*plotW;
      ctx.strokeStyle = m.color; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
      ctx.beginPath(); ctx.moveTo(x, padT); ctx.lineTo(x, padT+plotH); ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle = m.color; ctx.fillText(m.label, x, H - padB + 4);
    });

    // x-axis ticks (min, mean, max)
    ctx.fillStyle = '#9fb2c8'; ctx.textAlign='center'; ctx.textBaseline='top';
    const mean = s.mean;
    const ticks = [min, mean, max];
    ticks.forEach((t,i)=>{
      const x = padL + ((t - min)/(max-min))*plotW;
      ctx.fillText((i===0?'min ': i===1?'mean ':'max ') + t.toFixed(1), x, H - padB + 4 + (i===1?14:0));
    });
  }
  window.addEventListener('resize', drawHist);

  // ---------- Insights ----------
  function renderInsights(){
    const el = $('#insightsTbody');
    el.innerHTML = '';
    if(!state.results) return;
    const { tasks, critIdx, spread, scores } = state.results;
    const rows = tasks.map((t,i)=>({
      id: t.id, name: t.name||'', group: t.group||'',
      crit: critIdx[i], sp: spread[i], score: scores[i]
    })).sort((a,b)=> b.score - a.score);
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="kbd">${escapeHtml(r.id)}</td>
        <td>${escapeHtml(r.name)}</td>
        <td><span class="chip">${escapeHtml(r.group)}</span></td>
        <td>${(r.crit*100).toFixed(1)}%</td>
        <td>${r.sp.toFixed(1)}</td>
        <td><span class="kbd">${r.score.toFixed(2)}</span></td>
      `;
      el.appendChild(tr);
    }
  }

  // ---------- Narrative ----------
  function generateNarrative(){
    if(!state.results) return;
    const s = state.results.stats, tasks = state.results.tasks;
    const rows = tasks.map((t,i)=>({i, id:t.id, name:t.name||t.id, group:t.group||'', sp: state.results.spread[i], crit: state.results.critIdx[i], score: state.results.scores[i]}))
      .sort((a,b)=> b.score - a.score);
    const top = rows.slice(0,3);
    const buf = (s.p90 - s.p50);
    const startStr = $('#startDate').value ? new Date($('#startDate').value+'T12:00:00').toLocaleDateString() : 'the project start';
    const p50date = $('#dateP50').textContent, p80date = $('#dateP80').textContent, p90date = $('#dateP90').textContent;
    const line1 = `Using ${$('#distType').value==='pert'?'Beta‑PERT':'triangular'} Monte Carlo (${($('#iterations').value||'')}) over the task DAG, the expected duration is ${s.mean.toFixed(1)}±${s.sd.toFixed(1)} `+
                  `${unitLabel()} with P50=${s.p50.toFixed(1)}, P80=${s.p80.toFixed(1)}, P90=${s.p90.toFixed(1)} (finish by P50 ${p50date}, P80 ${p80date}, P90 ${p90date}).`;
    const line2 = `The implied project buffer (P90−P50) is ${buf.toFixed(1)} ${unitLabel()}, concentrated on ${top.map(t=>`${t.id} (${(t.crit*100).toFixed(0)}% crit, Δ=${t.sp.toFixed(1)})`).join('; ')}; `+
                  `I propose placing a project buffer of ${Math.ceil(buf)} ${unitLabel()} and feeding buffers before ${top[0]?.id||'—'}.`;
    const line3 = `We will treat the forecast as a confidence‑bound commitment rather than a single‑point date; debottlenecking ${top[0]?.id||'—'} yields the highest marginal reduction in P90.`;
    $('#narrative').value = [line1, line2, line3].join(' ');
  }
  function unitLabel(){ return $('#timeUnit').value==='wdays'?'working days':'days'; }

  // ---------- What-if ----------
  $('#whatIfPct').addEventListener('input', e=> $('#whatIfLabel').textContent = e.target.value+'%');
  $('#btnWhatIf').addEventListener('click', ()=>{
    if(!state.results){ alert('Run a baseline simulation first.'); return; }
    const pct = parseFloat($('#whatIfPct').value||'0')/100;
    const base = state.results.tasks.map(t => ({...t}));
    // top 3 by score
    const {scores} = state.results;
    const idxs = scores.map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]).slice(0,3).map(x=>x[1]);
    idxs.forEach(i => { base[i].p = Math.max(base[i].m, base[i].p*(1-pct)); });
    runSimulation(base, true);
  });

  // ---------- Helpers & UI ----------
  $('#btnAddRow').addEventListener('click', ()=> addRow(null));
  $('#btnSave').addEventListener('click', saveState);
  $('#btnReset').addEventListener('click', ()=>{
    if(confirm('Clear all tasks and results?')){ state.tasks=[]; renderTasks(); state.results=null; drawHist(); $('#insightsTbody').innerHTML=''; saveState(); }
  });
  $('#btnLoadExample').addEventListener('click', ()=>{
    if(!confirm('Replace current tasks with an example?')) return;
    state.tasks = exampleTasks();
    renderTasks(); saveState();
  });
  ['startDate','iterations','distType','timeUnit','narrative'].forEach(id=> $('#'+id).addEventListener('change', saveState));

  function exampleTasks(){
    return [
      {id:'D1', name:'Problem framing & scope', group:'Discovery', o:1, m:2, p:4, deps:[]},
      {id:'D2', name:'Data availability & contract', group:'Partner', o:2, m:3, p:8, deps:['D1']},
      {id:'M1', name:'Model baseline', group:'ML', o:2, m:5, p:12, deps:['D1']},
      {id:'B1', name:'AuthN/AuthZ patch', group:'Backend', o:1, m:2, p:5, deps:['D1']},
      {id:'B2', name:'Feature endpoint v1', group:'Backend', o:2, m:5, p:9, deps:['B1']},
      {id:'I1', name:'Integration with partner', group:'Backend', o:3, m:5, p:12, deps:['D2','B2']},
      {id:'F1', name:'UI slice', group:'Frontend', o:2, m:4, p:8, deps:['B2']},
      {id:'Q1', name:'E2E tests', group:'QA', o:2, m:3, p:6, deps:['I1','F1']},
      {id:'M2', name:'Model fine‑tune', group:'ML', o:2, m:4, p:9, deps:['M1']},
      {id:'L1', name:'Pilot rollout', group:'Launch', o:1, m:2, p:5, deps:['Q1','M2']}
    ];
  }

  // Initial load
  if(!tryLoadFromHash()){
    if(!loadState()){
      renderTasks(); // seeds with defaults if empty
    }
  }

  // Draw after load (in case)
  drawHist();
})();
</script>
</body>
</html>
