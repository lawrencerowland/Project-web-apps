<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monotone Co-Design — Incremental Rail Upgrade (Worked Example)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101824; --panel2:#0f1722; --text:#e8eef7; --muted:#b6c3d6;
      --green:#4ade80; --red:#fb7185; --amber:#fbbf24; --blue:#60a5fa; --line:#243447;
      --ok:#22c55e; --bad:#ef4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    html,body{height:100%;}
    body{margin:0; background:var(--bg); color:var(--text); font-family:var(--sans);}
    .wrap{max-width:1100px; margin:0 auto; padding:24px;}
    h1{margin:0 0 8px; font-size:22px; font-weight:750; letter-spacing:.2px;}
    p{margin:8px 0; color:var(--muted); line-height:1.45;}
    .grid{display:grid; grid-template-columns: 1.25fr .9fr; gap:16px; margin-top:16px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }

    .card{background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--line);
          border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; color:var(--muted);
          font-size:12px; display:inline-flex; gap:8px; align-items:center;}
    .dot{width:10px; height:10px; border-radius:999px; display:inline-block;}
    .dot.g{background:var(--green);} .dot.r{background:var(--red);} .dot.b{background:var(--blue);} .dot.a{background:var(--amber);}
    .btn{cursor:pointer; user-select:none; border:1px solid var(--line); background:#0b1220; color:var(--text);
         padding:8px 10px; border-radius:12px; font-weight:650; font-size:13px;}
    .btn:hover{border-color:#35506a;}
    .btn.on{border-color: var(--blue); box-shadow: 0 0 0 3px rgba(96,165,250,.12) inset;}

    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:12px;}
    @media (max-width: 700px){ .kpi{grid-template-columns:1fr;} }
    .kbox{border:1px solid var(--line); border-radius:14px; padding:10px; background:rgba(0,0,0,.14);}    
    .klabel{font-size:12px; color:var(--muted);} 
    .kval{font-family:var(--mono); font-size:16px; margin-top:6px;}

    .control{margin-top:12px; padding-top:12px; border-top:1px solid var(--line);}    
    .ctrl{display:grid; grid-template-columns: 220px 1fr 80px; gap:10px; align-items:center; margin:10px 0;}
    @media (max-width: 700px){ .ctrl{grid-template-columns: 1fr; } }
    input[type=range]{width:100%;}
    .mono{font-family:var(--mono);}    

    .log{margin-top:12px; border:1px solid var(--line); border-radius:14px; padding:10px; background:rgba(0,0,0,.18);
         max-height:220px; overflow:auto; font-family:var(--mono); font-size:12px; line-height:1.35;}
    .log .ok{color:var(--ok);} .log .bad{color:var(--bad);} .log .muted{color:var(--muted);} 

    svg{width:100%; height:auto;}
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .small{font-size:12px; color:var(--muted);}    

    table{width:100%; border-collapse:collapse; font-size:12px;}
    th,td{padding:8px; border-bottom:1px solid rgba(36,52,71,.55); text-align:left;}
    th{color:var(--muted); font-weight:700;}
    tr:hover td{background:rgba(96,165,250,.06);}    

    .badge{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--line);}
    .badge.ok{border-color: rgba(34,197,94,.5); color: rgba(34,197,94,.95);} 
    .badge.warn{border-color: rgba(251,191,36,.55); color: rgba(251,191,36,.95);} 
    .badge.bad{border-color: rgba(239,68,68,.55); color: rgba(239,68,68,.95);} 
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Monotone Co-Design — Incremental Rail Upgrade (Platforms ↔ Signalling ↔ Power)</h1>
    <p>
      Move the platform length; the tool enforces the induced minima for signalling and power. Toggle <span class="mono">Catalogue</span> to switch from smooth monotone maps to discrete vendor options (multiple minimal solutions / Pareto antichain intuition).
      The diagram uses canonical iconography: dashed green = functionalities, solid red = resources.
    </p>

    <div class="row">
      <span class="pill"><span class="dot g"></span>Functionality</span>
      <span class="pill"><span class="dot r"></span>Resource</span>
      <span class="pill"><span class="dot b"></span>Constraint / coupling</span>
      <span class="pill"><span class="dot a"></span>Stage gate</span>
      <button id="modeBtn" class="btn">Catalogue: OFF</button>
      <button id="resetBtn" class="btn">Reset</button>
      <button id="snapBtn" class="btn">Snap to minimal feasible</button>
    </div>

    <div class="grid">
      <!-- Left: Diagram + narrative -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="mono" style="font-weight:800;">Co-design diagram (toy skeleton)</div>
            <div class="small">P provides platform length; S provides throughput; E provides power capacity. Couplings enforce monotone co-moves.</div>
          </div>
          <span class="pill"><span class="dot a"></span><span id="stagePill">Stage: 0 (Baseline)</span></span>
        </div>

        <div style="margin-top:12px;">
          <svg viewBox="0 0 980 420" aria-label="Co-design diagram">
            <!-- Boxes -->
            <defs>
              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="#000" flood-opacity=".35" />
              </filter>
              <marker id="arrowG" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L10,3 L0,6 z" fill="var(--green)" />
              </marker>
              <marker id="arrowR" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L10,3 L0,6 z" fill="var(--red)" />
              </marker>
              <marker id="arrowB" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L10,3 L0,6 z" fill="var(--blue)" />
              </marker>
            </defs>

            <g filter="url(#shadow)">
              <rect x="80" y="110" width="240" height="180" rx="18" fill="#0c1523" stroke="#243447" stroke-width="2" />
              <rect x="370" y="60" width="240" height="180" rx="18" fill="#0c1523" stroke="#243447" stroke-width="2" />
              <rect x="660" y="110" width="240" height="180" rx="18" fill="#0c1523" stroke="#243447" stroke-width="2" />
            </g>

            <!-- Titles -->
            <text x="200" y="145" text-anchor="middle" fill="#e8eef7" font-size="18" font-weight="800">Platform (P)</text>
            <text x="490" y="95" text-anchor="middle" fill="#e8eef7" font-size="18" font-weight="800">Signalling (S)</text>
            <text x="780" y="145" text-anchor="middle" fill="#e8eef7" font-size="18" font-weight="800">Power (E)</text>

            <!-- Functionalities: dashed green -->
            <line x1="320" y1="200" x2="360" y2="200" stroke="var(--green)" stroke-width="4" stroke-dasharray="10 8" marker-end="url(#arrowG)" />
            <text x="340" y="190" text-anchor="middle" fill="var(--green)" font-size="12">L (m)</text>

            <line x1="610" y1="150" x2="650" y2="180" stroke="var(--green)" stroke-width="4" stroke-dasharray="10 8" marker-end="url(#arrowG)" />
            <text x="632" y="145" text-anchor="start" fill="var(--green)" font-size="12">T (tph)</text>

            <!-- Resources: solid red going out -->
            <line x1="80" y1="260" x2="40" y2="260" stroke="var(--red)" stroke-width="4" marker-end="url(#arrowR)" />
            <text x="45" y="248" text-anchor="start" fill="var(--red)" font-size="12">£, possessions</text>

            <line x1="370" y1="210" x2="330" y2="240" stroke="var(--red)" stroke-width="4" marker-end="url(#arrowR)" />
            <text x="305" y="252" text-anchor="end" fill="var(--red)" font-size="12">£, validation</text>

            <line x1="900" y1="260" x2="940" y2="260" stroke="var(--red)" stroke-width="4" marker-end="url(#arrowR)" />
            <text x="935" y="248" text-anchor="end" fill="var(--red)" font-size="12">£, grid lead time</text>

            <!-- Coupling nodes (blue constraint squares) -->
            <rect x="345" y="185" width="30" height="30" rx="6" fill="#0b1220" stroke="var(--blue)" stroke-width="2" />
            <text x="360" y="205" text-anchor="middle" fill="var(--blue)" font-size="14" font-weight="900">∿</text>

            <rect x="635" y="175" width="30" height="30" rx="6" fill="#0b1220" stroke="var(--blue)" stroke-width="2" />
            <text x="650" y="195" text-anchor="middle" fill="var(--blue)" font-size="14" font-weight="900">∿</text>

            <!-- Coupling arrows (blue) -->
            <line x1="375" y1="200" x2="370" y2="150" stroke="var(--blue)" stroke-width="3" marker-end="url(#arrowB)" />
            <text x="382" y="175" fill="var(--blue)" font-size="12">T ≥ f(L)</text>

            <line x1="665" y1="190" x2="660" y2="200" stroke="var(--blue)" stroke-width="3" marker-end="url(#arrowB)" />
            <text x="675" y="226" fill="var(--blue)" font-size="12">Π ≥ g(T)</text>

            <!-- Feedback loop (business case) -->
            <path d="M 490 250 C 490 340, 250 360, 200 300" fill="none" stroke="#fbbf24" stroke-width="3" stroke-dasharray="8 8" marker-end="url(#arrowB)" />
            <text x="330" y="360" fill="#fbbf24" font-size="12">"business case" loop (abstract)</text>
          </svg>
        </div>

        <div class="legend">
          <span class="pill"><span class="dot g"></span>increase functionality ⇒ cannot reduce feasible resources</span>
          <span class="pill"><span class="dot b"></span>coupling = co-design constraint</span>
          <span class="pill"><span class="dot a"></span>stages are monotone steps</span>
        </div>

        <div class="control">
          <div class="mono" style="font-weight:800;">Stage planner</div>
          <p class="small">Stage is derived from platform length (baseline 200m). Stage gates are illustrative: they represent procurement + regulatory closure points.</p>

          <div class="ctrl">
            <div class="mono">Platform length L (m)</div>
            <input id="L" type="range" min="200" max="300" value="200" step="10" />
            <div class="mono" id="Lval">200</div>
          </div>

          <div class="ctrl">
            <div class="mono">Throughput T (tph)</div>
            <input id="T" type="range" min="18" max="36" value="18" step="1" />
            <div class="mono" id="Tval">18</div>
          </div>

          <div class="ctrl">
            <div class="mono">Power capacity Π (MW)</div>
            <input id="P" type="range" min="10" max="30" value="10" step="1" />
            <div class="mono" id="Pval">10</div>
          </div>

          <div class="kpi">
            <div class="kbox">
              <div class="klabel">Implied minimum T for current L</div>
              <div class="kval" id="minT">18</div>
            </div>
            <div class="kbox">
              <div class="klabel">Implied minimum Π for current T</div>
              <div class="kval" id="minP">10</div>
            </div>
            <div class="kbox">
              <div class="klabel">Feasibility status</div>
              <div class="kval" id="status"><span class="badge ok">FEASIBLE</span></div>
            </div>
          </div>

          <div class="log" id="log"></div>
        </div>
      </div>

      <!-- Right: Catalogue and governance -->
      <div class="card">
        <div class="mono" style="font-weight:800;">Catalogue view (discrete options)</div>
        <p class="small">
          In MCDP terms, a <span class="mono">catalogue</span> defines an arbitrary (non-smooth, non-convex) relation between function and resources; multiple non-dominated solutions can coexist.
          Here we treat each subsystem as a small catalogue with cost trade-offs.
        </p>

        <table>
          <thead>
            <tr><th>Package</th><th>Provides</th><th>Requires</th><th>Status</th></tr>
          </thead>
          <tbody id="catTable"></tbody>
        </table>

        <div class="control">
          <div class="mono" style="font-weight:800;">Governance checks (toy)</div>
          <p class="small">A director’s view: lock in monotone commitments, then surface the minimal co-moves as “must-do now” rather than “surprise later.”</p>

          <div class="kpi">
            <div class="kbox">
              <div class="klabel">Capex proxy (£m)</div>
              <div class="kval" id="capex">0</div>
            </div>
            <div class="kbox">
              <div class="klabel">Possession proxy (nights)</div>
              <div class="kval" id="poss">0</div>
            </div>
            <div class="kbox">
              <div class="klabel">Validation proxy (effort)</div>
              <div class="kval" id="valeff">0</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="stageDown" class="btn">Stage −</button>
            <button id="stageUp" class="btn">Stage +</button>
            <span class="pill"><span class="dot a"></span><span class="mono">Monotone rule:</span> stage cannot decrease</span>
          </div>

          <div class="log" id="govLog"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------------------------
  // Core monotone maps (smooth mode)
  // ---------------------------
  // L in {200..300 step 10} → min throughput (tph)
  const minTForL = new Map([
    [200, 18], [210, 19], [220, 20], [230, 22], [240, 24],
    [250, 26], [260, 28], [270, 30], [280, 32], [290, 34], [300, 36]
  ]);
  // T in [18..36] → min power (MW)
  function minPForT(t){
    // convex-ish increasing map (illustrative)
    // base + linear + quadratic term
    const base = 10;
    const lin = 0.35 * (t - 18);
    const quad = 0.03 * (t - 18) * (t - 18);
    return Math.min(30, Math.max(10, Math.round(base + lin + quad)));
  }

  // ---------------------------
  // Catalogue options (discrete alternatives)
  // Each option: provides + requires (cost proxies)
  // ---------------------------
  const cat = {
    P: [
      {name:"P0 Baseline", L:200, capex:0, poss:0},
      {name:"P1 +10m", L:210, capex:8, poss:2},
      {name:"P2 +20m", L:220, capex:15, poss:3},
      {name:"P3 +30m", L:230, capex:25, poss:5},
      {name:"P4 +40m", L:240, capex:35, poss:6},
      {name:"P5 +50m", L:250, capex:50, poss:8},
      {name:"P6 +60m", L:260, capex:70, poss:10},
      {name:"P7 +70m", L:270, capex:95, poss:13},
      {name:"P8 +80m", L:280, capex:125, poss:16},
      {name:"P9 +90m", L:290, capex:160, poss:20},
      {name:"P10 +100m", L:300, capex:200, poss:25}
    ],
    S: [
      {name:"S0 Legacy", T:18, capex:0, val:0},
      {name:"S1 T+1", T:19, capex:5, val:1},
      {name:"S2 T+2", T:20, capex:9, val:1},
      {name:"S3 T+4", T:22, capex:20, val:2},
      {name:"S4 T+6", T:24, capex:35, val:3},
      {name:"S5 T+8", T:26, capex:55, val:4},
      {name:"S6 T+10", T:28, capex:80, val:6},
      {name:"S7 T+12", T:30, capex:110, val:8},
      {name:"S8 T+14", T:32, capex:145, val:10},
      {name:"S9 T+16", T:34, capex:185, val:12},
      {name:"S10 T+18", T:36, capex:230, val:15}
    ],
    E: [
      {name:"E0 Existing", P:10, capex:0},
      {name:"E1 +1MW", P:11, capex:4},
      {name:"E2 +2MW", P:12, capex:7},
      {name:"E3 +3MW", P:13, capex:11},
      {name:"E4 +5MW", P:15, capex:20},
      {name:"E5 +7MW", P:17, capex:30},
      {name:"E6 +10MW", P:20, capex:45},
      {name:"E7 +13MW", P:23, capex:65},
      {name:"E8 +16MW", P:26, capex:90},
      {name:"E9 +18MW", P:28, capex:110},
      {name:"E10 +20MW", P:30, capex:135}
    ]
  };

  // ---------------------------
  // State
  // ---------------------------
  const els = {
    modeBtn: document.getElementById('modeBtn'),
    resetBtn: document.getElementById('resetBtn'),
    snapBtn: document.getElementById('snapBtn'),

    L: document.getElementById('L'), T: document.getElementById('T'), P: document.getElementById('P'),
    Lval: document.getElementById('Lval'), Tval: document.getElementById('Tval'), Pval: document.getElementById('Pval'),

    minT: document.getElementById('minT'),
    minP: document.getElementById('minP'),
    status: document.getElementById('status'),

    log: document.getElementById('log'),
    govLog: document.getElementById('govLog'),

    catTable: document.getElementById('catTable'),
    capex: document.getElementById('capex'),
    poss: document.getElementById('poss'),
    valeff: document.getElementById('valeff'),

    stagePill: document.getElementById('stagePill'),
    stageDown: document.getElementById('stageDown'),
    stageUp: document.getElementById('stageUp'),
  };

  let catalogueMode = false;
  let stage = 0;              // derived gate index, monotone (cannot decrease via stage buttons)
  let lastCommittedStage = 0; // governance monotone commitment

  function stageFromL(L){ return Math.round((L - 200)/10); }
  function LFromStage(s){ return 200 + 10*s; }

  function logLine(target, html){
    const div = document.createElement('div');
    div.innerHTML = html;
    target.prepend(div);
  }

  function badge(ok, text){
    const cls = ok ? 'ok' : 'bad';
    return `<span class="badge ${cls}">${text}</span>`;
  }

  // ---------------------------
  // Feasibility + snapping logic
  // ---------------------------
  function computeSmoothMinima(L, T){
    const mT = minTForL.get(L) ?? 18;
    const mP = minPForT(T);
    return {mT, mP};
  }

  function snapToFeasible(){
    const L = parseInt(els.L.value, 10);
    let T = parseInt(els.T.value, 10);
    let P = parseInt(els.P.value, 10);

    const {mT} = computeSmoothMinima(L, T);
    if(T < mT){
      logLine(els.log, `<span class='bad'>snap:</span> T raised ${T} → ${mT} to satisfy T ≥ f(L).`);
      T = mT;
      els.T.value = T;
    }

    const {mP} = computeSmoothMinima(L, T);
    if(P < mP){
      logLine(els.log, `<span class='bad'>snap:</span> Π raised ${P} → ${mP} to satisfy Π ≥ g(T).`);
      P = mP;
      els.P.value = P;
    }

    updateUI('snap');
  }

  function smoothFeasible(L, T, P){
    const {mT} = computeSmoothMinima(L, T);
    const {mP} = computeSmoothMinima(L, Math.max(T, mT));
    return (T >= mT) && (P >= mP);
  }

  // ---------------------------
  // Catalogue selection: choose minimal feasible options for each subsystem
  // (Here: pick the cheapest option that meets required minima)
  // ---------------------------
  function pickCatalogue(L, T, P){
    const reqT = (minTForL.get(L) ?? 18);
    const reqP = minPForT(Math.max(T, reqT));

    const pOpt = cat.P.find(o => o.L === L) ?? cat.P[0];
    const sOpt = [...cat.S].filter(o => o.T >= reqT).sort((a,b)=>a.capex-b.capex)[0] ?? cat.S[cat.S.length-1];
    const eOpt = [...cat.E].filter(o => o.P >= reqP).sort((a,b)=>a.capex-b.capex)[0] ?? cat.E[cat.E.length-1];

    // “Pareto” note: different sOpt/eOpt could tie; we keep cheapest proxy for simplicity.
    const feasible = (sOpt.T >= reqT) && (eOpt.P >= reqP);

    return {reqT, reqP, pOpt, sOpt, eOpt, feasible};
  }

  function renderCatalogueView(){
    const L = parseInt(els.L.value, 10);
    const T = parseInt(els.T.value, 10);
    const P = parseInt(els.P.value, 10);

    const sel = pickCatalogue(L, T, P);

    const rows = [
      {pkg:'P (Platform)', provides:`L=${sel.pOpt.L}m`, requires:`£${sel.pOpt.capex}m, ${sel.pOpt.poss} nights`, ok:true},
      {pkg:'S (Signalling)', provides:`T=${sel.sOpt.T} tph (req ≥ ${sel.reqT})`, requires:`£${sel.sOpt.capex}m, val=${sel.sOpt.val}`, ok: sel.sOpt.T >= sel.reqT},
      {pkg:'E (Power)', provides:`Π=${sel.eOpt.P} MW (req ≥ ${sel.reqP})`, requires:`£${sel.eOpt.capex}m`, ok: sel.eOpt.P >= sel.reqP},
    ];

    els.catTable.innerHTML = rows.map(r => {
      const st = r.ok ? `<span class='badge ok'>OK</span>` : `<span class='badge bad'>FAIL</span>`;
      return `<tr><td class='mono'>${r.pkg}</td><td class='mono'>${r.provides}</td><td class='mono'>${r.requires}</td><td>${st}</td></tr>`;
    }).join('');

    const capex = sel.pOpt.capex + sel.sOpt.capex + sel.eOpt.capex;
    const poss = sel.pOpt.poss;
    const val = sel.sOpt.val;

    els.capex.textContent = `${capex}`;
    els.poss.textContent = `${poss}`;
    els.valeff.textContent = `${val}`;

    if(!sel.feasible){
      logLine(els.govLog, `<span class='bad'>catalogue infeasible:</span> need T≥${sel.reqT}, Π≥${sel.reqP}. Consider different packages or relax functionality.`);
    } else {
      logLine(els.govLog, `<span class='ok'>catalogue feasible:</span> selected minimal-cost options meeting req(T,Π) given L.`);
    }
  }

  // ---------------------------
  // UI update
  // ---------------------------
  function updateUI(reason){
    const L = parseInt(els.L.value, 10);
    const T = parseInt(els.T.value, 10);
    const P = parseInt(els.P.value, 10);

    els.Lval.textContent = String(L);
    els.Tval.textContent = String(T);
    els.Pval.textContent = String(P);

    // stage derived from L
    stage = stageFromL(L);
    els.stagePill.textContent = `Stage: ${stage} (${stage === 0 ? 'Baseline' : `Gate ${stage}`})`;

    // minima
    const smoothMin = computeSmoothMinima(L, T);
    els.minT.textContent = String(smoothMin.mT);
    els.minP.textContent = String(smoothMin.mP);

    // feasibility
    const ok = smoothFeasible(L, T, P);
    els.status.innerHTML = ok ? `<span class='badge ok'>FEASIBLE</span>` : `<span class='badge bad'>INFEASIBLE</span>`;

    if(reason){
      const cls = ok ? 'ok' : 'bad';
      logLine(els.log, `<span class='muted'>${new Date().toLocaleTimeString()}</span> <span class='${cls}'>${reason}</span> L=${L}, T=${T}, Π=${P} (minT=${smoothMin.mT}, minP=${smoothMin.mP})`);
    }

    if(catalogueMode){
      renderCatalogueView();
    } else {
      // clear table gently
      els.catTable.innerHTML = `<tr><td colspan='4' class='small'>Catalogue mode is OFF. Toggle to view discrete vendor options.</td></tr>`;
      els.capex.textContent = '—';
      els.poss.textContent = '—';
      els.valeff.textContent = '—';
    }

    // governance monotone commitment (stage cannot decrease once committed)
    if(stage < lastCommittedStage){
      // revert to committed stage
      const backL = LFromStage(lastCommittedStage);
      els.L.value = backL;
      logLine(els.govLog, `<span class='bad'>governance:</span> attempted to reduce stage ${stage} below committed ${lastCommittedStage}; reverting L→${backL}.`);
      // re-run after revert
      updateUI('governance revert');
      return;
    }
  }

  // ---------------------------
  // Events
  // ---------------------------
  els.L.addEventListener('input', ()=>{
    // platform move: do not auto-snap; we show infeasible state until snap or until user moves others.
    updateUI('L changed');
  });
  els.T.addEventListener('input', ()=> updateUI('T changed'));
  els.P.addEventListener('input', ()=> updateUI('Π changed'));

  els.snapBtn.addEventListener('click', ()=> snapToFeasible());

  els.modeBtn.addEventListener('click', ()=>{
    catalogueMode = !catalogueMode;
    els.modeBtn.textContent = `Catalogue: ${catalogueMode ? 'ON' : 'OFF'}`;
    els.modeBtn.classList.toggle('on', catalogueMode);
    updateUI('mode toggled');
  });

  els.resetBtn.addEventListener('click', ()=>{
    els.L.value = 200; els.T.value = 18; els.P.value = 10;
    lastCommittedStage = 0;
    els.govLog.innerHTML = '';
    els.log.innerHTML = '';
    logLine(els.govLog, `<span class='ok'>reset:</span> commitments cleared; back to baseline.`);
    updateUI('reset');
  });

  // Stage buttons simulate “gate closure” (director commits to a stage; cannot go backwards)
  els.stageUp.addEventListener('click', ()=>{
    const next = Math.min(10, Math.max(lastCommittedStage, stage) + 1);
    lastCommittedStage = next;
    els.L.value = LFromStage(next);
    logLine(els.govLog, `<span class='ok'>commit:</span> stage committed to ${next}; L set to ${LFromStage(next)}.`);
    updateUI('stage committed');
  });

  els.stageDown.addEventListener('click', ()=>{
    // cannot decrease commitment; this button illustrates that governance blocks it
    const attempted = Math.max(0, lastCommittedStage - 1);
    logLine(els.govLog, `<span class='bad'>blocked:</span> cannot reduce committed stage ${lastCommittedStage} → ${attempted}. Monotone commitments forbid backsliding.`);
    updateUI('stage down blocked');
  });

  // Init
  els.log.innerHTML = '';
  els.govLog.innerHTML = '';
  logLine(els.log, `<span class='ok'>ready:</span> start from baseline; raise L then snap.`);
  logLine(els.govLog, `<span class='muted'>note:</span> stage commitments are monotone; use Stage+ to commit.`);
  updateUI('init');
</script>
</body>
</html>
